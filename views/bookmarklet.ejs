(function(to, url) {
  var kindlebility = function() {
    var div = document.createElement('div');
    div.id = 'kindlebility';
    div.style.width = '200px';
    div.style.height = '30px';
    div.style.position = 'fixed';
    div.style.top = '10px';
    div.style.left = '10px';
    div.style.background = 'white';
    div.style.borderColor = 'black';
    div.style.borderStyle = 'solid';
    div.style.borderWidth = '2px';
    div.style.zIndex = '999';
    div.style.padding = '5px';
    div.style.paddingTop = '16px';
    div.style.textAlign = 'center';
    var body = document.getElementsByTagName('body')[0];
    body.appendChild(div);
    div.innerText = 'Working...';

    var socket = new io.Socket('localhost', { port: 9090 });
    socket.on('message', function(data) {
      if ('done' == data) {
        body.removeChild(div);
        socket.disconnect();
      } else {
        div.innerHTML = data;
      }
    });
    socket.connect();
    socket.send(JSON.stringify({ url: url, to: to }));
  };

  var loadSocketIO = function(callback) {
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'http://localhost:9090/socket.io/socket.io.js';
    script.onload = callback;
    var head = document.getElementsByTagName('head')[0];
    head.appendChild(script);
  };

  var socketIOLoaded = function() {
    return window.io && window.io.Socket && 'function' == typeof(window.io.Socket);
  };

  socketIOLoaded() ? kindlebility() : loadSocketIO(kindlebility);
})('<%= to %>', document.location.href);